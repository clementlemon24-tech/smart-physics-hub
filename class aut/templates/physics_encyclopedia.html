{% extends "base.html" %}

{% block title %}Physics Encyclopedia - Smart Physics Hub{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-book-open"></i> Complete Physics Encyclopedia</h1>
        <p class="lead">Comprehensive physics reference with all formulas, explanations, and examples by Engineer Clement Ekelemchi</p>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="search-input" placeholder="Search formulas, concepts, or examples...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="topic-filter">
                            <option value="">All Topics</option>
                            {% for topic_key, topic_data in physics_db.items() %}
                            <option value="{{ topic_key }}">{{ topic_data.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="searchPhysics()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Physics Topics -->
<div class="row">
    {% for topic_key, topic_data in physics_db.items() %}
    <div class="col-12 mb-4 topic-section" data-topic="{{ topic_key }}">
        <div class="card">
            <div class="card-header bg-{{ topic_data.color }} text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3><i class="{{ topic_data.icon }}"></i> {{ topic_data.title }}</h3>
                    <button class="btn btn-outline-light btn-sm" onclick="toggleTopic('{{ topic_key }}')">
                        <i class="fas fa-chevron-down" id="toggle-{{ topic_key }}"></i>
                    </button>
                </div>
                <p class="mb-0 mt-2">{{ topic_data.description }}</p>
            </div>
            <div class="card-body topic-content" id="content-{{ topic_key }}">
                {% for subtopic_key, subtopic_data in topic_data.subtopics.items() %}
                <div class="subtopic-section mb-4" data-subtopic="{{ subtopic_key }}">
                    <h4 class="text-{{ topic_data.color }}">
                        <i class="fas fa-bookmark"></i> {{ subtopic_data.title }}
                    </h4>
                    <p class="lead">{{ subtopic_data.description }}</p>
                    
                    <!-- Formulas Section -->
                    <div class="formulas-section mb-4">
                        <h5><i class="fas fa-calculator text-primary"></i> Key Formulas</h5>
                        <div class="row">
                            {% for formula, explanation in subtopic_data.formulas.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="formula-card">
                                    <div class="formula-display">
                                        <code class="formula-text">{{ formula }}</code>
                                        <button class="btn btn-sm btn-outline-info ms-2" onclick="speakFormula('{{ formula }}', '{{ explanation }}')">
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                    </div>
                                    <div class="formula-explanation">
                                        {{ explanation }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Examples Section -->
                    <div class="examples-section mb-4">
                        <h5><i class="fas fa-lightbulb text-warning"></i> Real-World Examples</h5>
                        <div class="row">
                            {% for example in subtopic_data.examples %}
                            <div class="col-md-4 mb-2">
                                <div class="example-card">
                                    <i class="fas fa-arrow-right text-success"></i> {{ example }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Applications Section -->
                    <div class="applications-section mb-4">
                        <h5><i class="fas fa-cogs text-info"></i> Applications</h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for application in subtopic_data.applications %}
                            <span class="badge bg-info fs-6">{{ application }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Interactive Actions -->
                    <div class="actions-section">
                        <button class="btn btn-success btn-sm me-2" onclick="practiceProblems('{{ subtopic_key }}')">
                            <i class="fas fa-pencil-alt"></i> Practice Problems
                        </button>
                        <button class="btn btn-primary btn-sm me-2" onclick="askAITutor('{{ subtopic_data.title }}')">
                            <i class="fas fa-robot"></i> Ask Engineer C
                        </button>
                        <button class="btn btn-info btn-sm me-2" onclick="goToLab('{{ subtopic_key }}')">
                            <i class="fas fa-flask"></i> Virtual Lab
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="explainConcept('{{ subtopic_data.title }}', '{{ subtopic_data.description }}')">
                            <i class="fas fa-chalkboard-teacher"></i> Detailed Explanation
                        </button>
                    </div>
                </div>
                <hr>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Quick Reference Modal -->
<div class="modal fade" id="quickRefModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickRefTitle">Quick Reference</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="quickRefBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="goToClassroom()">
                    <i class="fas fa-chalkboard-teacher"></i> Learn in Classroom
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.topic-section {
    scroll-margin-top: 100px;
}

.formula-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    height: 100%;
    transition: transform 0.2s ease;
}

.formula-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.formula-display {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.formula-text {
    font-size: 1.2rem;
    font-weight: bold;
    color: #dc3545;
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.formula-explanation {
    font-size: 0.9rem;
    color: #6c757d;
    line-height: 1.4;
}

.example-card {
    background: #e8f5e8;
    border-left: 4px solid #28a745;
    padding: 10px;
    border-radius: 4px;
    font-size: 0.9rem;
}

.subtopic-section {
    border-left: 4px solid #007bff;
    padding-left: 20px;
    margin-left: 10px;
}

.topic-content {
    display: none;
}

.topic-content.show {
    display: block;
}

.search-highlight {
    background-color: yellow;
    font-weight: bold;
}

@media (max-width: 768px) {
    .formula-text {
        font-size: 1rem;
    }
    
    .subtopic-section {
        padding-left: 15px;
        margin-left: 5px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Show first topic by default
    const firstTopic = document.querySelector('.topic-section');
    if (firstTopic) {
        const topicKey = firstTopic.dataset.topic;
        toggleTopic(topicKey);
    }
});

function toggleTopic(topicKey) {
    const content = document.getElementById(`content-${topicKey}`);
    const icon = document.getElementById(`toggle-${topicKey}`);
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.className = 'fas fa-chevron-down';
    } else {
        // Hide all other topics
        document.querySelectorAll('.topic-content').forEach(el => {
            el.classList.remove('show');
        });
        document.querySelectorAll('[id^="toggle-"]').forEach(el => {
            el.className = 'fas fa-chevron-down';
        });
        
        // Show selected topic
        content.classList.add('show');
        icon.className = 'fas fa-chevron-up';
    }
}

function searchPhysics() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const topicFilter = document.getElementById('topic-filter').value;
    
    // Clear previous highlights
    document.querySelectorAll('.search-highlight').forEach(el => {
        el.outerHTML = el.innerHTML;
    });
    
    if (!searchTerm && !topicFilter) {
        // Show all topics
        document.querySelectorAll('.topic-section').forEach(el => {
            el.style.display = 'block';
        });
        return;
    }
    
    let foundResults = false;
    
    document.querySelectorAll('.topic-section').forEach(topicEl => {
        const topicKey = topicEl.dataset.topic;
        let topicVisible = false;
        
        // Apply topic filter
        if (topicFilter && topicKey !== topicFilter) {
            topicEl.style.display = 'none';
            return;
        }
        
        if (searchTerm) {
            // Search in formulas, explanations, examples
            const textContent = topicEl.textContent.toLowerCase();
            if (textContent.includes(searchTerm)) {
                topicVisible = true;
                foundResults = true;
                
                // Highlight search terms
                highlightSearchTerm(topicEl, searchTerm);
                
                // Expand the topic
                const content = topicEl.querySelector('.topic-content');
                content.classList.add('show');
                const icon = topicEl.querySelector('[id^="toggle-"]');
                if (icon) icon.className = 'fas fa-chevron-up';
            }
        } else {
            topicVisible = true;
        }
        
        topicEl.style.display = topicVisible ? 'block' : 'none';
    });
    
    if (searchTerm && !foundResults) {
        alert('No results found for "' + searchTerm + '". Try different keywords or ask Engineer Clement Ekelemchi for help!');
    }
}

function highlightSearchTerm(element, term) {
    const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
    );
    
    const textNodes = [];
    let node;
    while (node = walker.nextNode()) {
        textNodes.push(node);
    }
    
    textNodes.forEach(textNode => {
        const text = textNode.textContent;
        const regex = new RegExp(`(${term})`, 'gi');
        if (regex.test(text)) {
            const highlightedText = text.replace(regex, '<span class="search-highlight">$1</span>');
            const span = document.createElement('span');
            span.innerHTML = highlightedText;
            textNode.parentNode.replaceChild(span, textNode);
        }
    });
}

function speakFormula(formula, explanation) {
    const text = `The formula ${formula} means: ${explanation}`;
    
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.8;
        utterance.pitch = 0.7;
        utterance.volume = 0.9;
        
        // Try to use a male voice
        const voices = speechSynthesis.getVoices();
        const maleVoice = voices.find(voice => 
            voice.name.toLowerCase().includes('male') || 
            voice.name.toLowerCase().includes('david') ||
            voice.name.toLowerCase().includes('mark')
        );
        
        if (maleVoice) {
            utterance.voice = maleVoice;
        }
        
        speechSynthesis.speak(utterance);
    }
}

function practiceProblems(subtopic) {
    window.location.href = `/practice?topic=${subtopic}`;
}

function askAITutor(topic) {
    const question = `Explain ${topic} in detail with examples and applications`;
    window.location.href = `/tutor?question=${encodeURIComponent(question)}`;
}

function goToLab(subtopic) {
    window.location.href = `/virtual-lab?experiment=${subtopic}`;
}

function explainConcept(title, description) {
    document.getElementById('quickRefTitle').textContent = title;
    document.getElementById('quickRefBody').innerHTML = `
        <div class="concept-explanation">
            <h6>Concept Overview:</h6>
            <p>${description}</p>
            
            <h6>What Engineer Clement Ekelemchi Says:</h6>
            <div class="alert alert-info">
                <i class="fas fa-user-tie"></i>
                <strong>Engineer Clement Ekelemchi:</strong> "${title} is a fundamental concept in physics. ${description} 
                Understanding this concept is crucial for solving real-world problems and advancing in your physics studies. 
                Would you like me to explain this in more detail in the classroom or through the AI tutor?"
            </div>
            
            <h6>Next Steps:</h6>
            <ul>
                <li>Practice problems related to this concept</li>
                <li>Explore real-world applications</li>
                <li>Connect with other physics concepts</li>
                <li>Ask specific questions to the AI tutor</li>
            </ul>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('quickRefModal')).show();
    
    // Speak the explanation
    const explanationText = `${title}: ${description}. This is a fundamental concept in physics that helps us understand how the physical world works.`;
    speakFormula('', explanationText);
}

function goToClassroom() {
    window.location.href = '/classroom';
}

// Search on Enter key
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPhysics();
    }
});

// Filter change event
document.getElementById('topic-filter').addEventListener('change', function() {
    searchPhysics();
});

// Voice synthesis setup
if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = function() {
        console.log('Physics Encyclopedia: Voice synthesis ready');
    };
}
</script>
{% endblock %}