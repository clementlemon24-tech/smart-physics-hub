{% extends "base.html" %}

{% block title %}Reports - Pest Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">${{ "%.2f"|format(treatment_costs) }}</h3>
                <p class="mb-0">Total Treatment Costs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info">{{ severity_counts.values()|sum }}</h3>
                <p class="mb-0">Total Sightings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning">{{ severity_counts.get('high', 0) + severity_counts.get('critical', 0) }}</h3>
                <p class="mb-0">High Priority Cases</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ location_counts|length }}</h3>
                <p class="mb-0">Monitored Locations</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Severity Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle"></i> Sightings by Severity</h5>
            </div>
            <div class="card-body">
                <canvas id="severityChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    {% for severity, count in severity_counts.items() %}
                    <div class="d-flex justify-content-between">
                        <span class="severity-{{ severity }}">{{ severity.title() }}</span>
                        <span>{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Pest Type Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bug"></i> Sightings by Pest Type</h5>
            </div>
            <div class="card-body">
                <canvas id="pestTypeChart" width="400" height="200"></canvas>
                <div class="mt-3">
                    {% for pest_type, count in pest_type_counts.items() %}
                    <div class="d-flex justify-content-between">
                        <span>{{ pest_type.title() }}</span>
                        <span>{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map-marker-alt"></i> Activity by Location</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Total Sightings</th>
                                <th>Risk Level</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location_name, count in location_counts.items() %}
                            <tr>
                                <td>{{ location_name }}</td>
                                <td>{{ count }}</td>
                                <td>
                                    {% if count >= 5 %}
                                        <span class="badge bg-danger">High</span>
                                    {% elif count >= 3 %}
                                        <span class="badge bg-warning">Medium</span>
                                    {% elif count >= 1 %}
                                        <span class="badge bg-info">Low</span>
                                    {% else %}
                                        <span class="badge bg-success">None</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <!-- This would need to be calculated in the backend -->
                                    <span class="text-muted">Recent</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Export Data</h5>
            </div>
            <div class="card-body">
                <p>Export your pest tracking data for external analysis or reporting.</p>
                <button class="btn btn-outline-primary me-2" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
                <button class="btn btn-outline-secondary" onclick="printReport()">
                    <i class="fas fa-print"></i> Print Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Severity Chart
const severityCtx = document.getElementById('severityChart').getContext('2d');
new Chart(severityCtx, {
    type: 'doughnut',
    data: {
        labels: {{ severity_counts.keys()|list|tojson }},
        datasets: [{
            data: {{ severity_counts.values()|list|tojson }},
            backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Pest Type Chart
const pestTypeCtx = document.getElementById('pestTypeChart').getContext('2d');
new Chart(pestTypeCtx, {
    type: 'bar',
    data: {
        labels: {{ pest_type_counts.keys()|list|tojson }},
        datasets: [{
            label: 'Sightings',
            data: {{ pest_type_counts.values()|list|tojson }},
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

function exportToCSV() {
    // This would make an API call to generate CSV data
    fetch('/api/sightings')
        .then(response => response.json())
        .then(data => {
            const csv = convertToCSV(data);
            downloadCSV(csv, 'pest_sightings.csv');
        });
}

function convertToCSV(data) {
    const headers = ['Date', 'Pest', 'Location', 'Severity', 'Description'];
    const csvContent = [
        headers.join(','),
        ...data.map(row => [
            row.date,
            row.pest_name,
            row.location_name,
            row.severity,
            `"${row.description}"`
        ].join(','))
    ].join('\n');
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function printReport() {
    window.print();
}
</script>
{% endblock %}